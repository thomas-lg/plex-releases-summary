# Blocks merging if the PR title does not follow the conventional commit format.
# The prefix must match one of the types defined in .github/conventional-commit-types.json,
# which is also the source of truth for the 'Label PR from Conventional Commit' workflow.
name: Enforce Conventional Commit Title

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  check-labels:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fail if PR title does not follow conventional commit format
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            let typeMap;
            try {
              typeMap = JSON.parse(fs.readFileSync('.github/conventional-commit-types.json', 'utf8'));
            } catch (e) {
              core.setFailed(`❌ Failed to load .github/conventional-commit-types.json: ${e.message}`);
              return;
            }
            const validTypes = Object.keys(typeMap);

            const titlePattern = new RegExp(
              `^(${validTypes.join('|')})(\\(.+\\))?!?: .+`
            );

            const title = context.payload.pull_request.title;

            if (!titlePattern.test(title)) {
              core.setFailed(
                `❌ PR title does not follow the conventional commit format.\n\n` +
                `Expected: <type>[optional scope]: <description>\n` +
                `Example: feat: add new feature\n\n` +
                `Valid types: ${validTypes.join(', ')}\n\n` +
                `Current title: "${title}"`
              );
            } else {
              console.log(`✅ PR title is valid: "${title}"`);
            }
